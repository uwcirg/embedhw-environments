---
services:
  celery:
    extends:
      file: ../base/docker-compose.yaml
      service: celery
    env_file:
      confidentialbackend.env

  confidentialbackend:
    extends:
      file: ../base/docker-compose.yaml
      service: confidentialbackend
    env_file:
      confidentialbackend.env

  summary:
    extends:
      file: ../base/docker-compose.yaml
      service: summary
    env_file:
      - summary.env

  fhir:
    extends:
      file: ../base/docker-compose.yaml
      service: fhir
    networks:
      # expose HAPI to internet
      ingress:
    labels:
      # unauthenticated route
      - traefik.enable=true
      - traefik.http.routers.fhir-${COMPOSE_PROJECT_NAME}.rule=Host(`fhir.${BASE_DOMAIN}`)
      - traefik.http.routers.fhir-${COMPOSE_PROJECT_NAME}.entrypoints=websecure
      - traefik.http.routers.fhir-${COMPOSE_PROJECT_NAME}.tls.certresolver=letsencrypt

  launchcache:
    extends:
      file: ../base/docker-compose.yaml
      service: launchcache
    networks:
      # expose LAUNCH CACHE HAPI to internet
      ingress:
    labels:
      # unauthenticated route
      - traefik.enable=true
      - traefik.http.routers.launchcache-${COMPOSE_PROJECT_NAME}.rule=Host(`launchcache.${BASE_DOMAIN}`)
      - traefik.http.routers.launchcache-${COMPOSE_PROJECT_NAME}.entrypoints=websecure
      - traefik.http.routers.launchcache-${COMPOSE_PROJECT_NAME}.tls.certresolver=letsencrypt

  logs:
    extends:
      file: ../base/docker-compose.yaml
      service: logs
    env_file:
      - logs.env
    labels:
      - traefik.http.routers.logs-${COMPOSE_PROJECT_NAME}.rule=Host(`logs.${BASE_DOMAIN}`)
      - traefik.http.routers.logs-${COMPOSE_PROJECT_NAME}.entrypoints=websecure
      - traefik.http.routers.logs-${COMPOSE_PROJECT_NAME}.tls=true
      - traefik.http.routers.logs-${COMPOSE_PROJECT_NAME}.tls.certresolver=letsencrypt

  db:
    extends:
      file: ../base/docker-compose.yaml
      service: db

  redis:
    extends:
      file: ../base/docker-compose.yaml
      service: redis

volumes:
  db-data: {}
  log-files: {}

networks:
  # internal network for backing services
  internal:

  # ingress network
  ingress:
    external: true
    name: external_web
